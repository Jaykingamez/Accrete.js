<html>
  <head>
    <title>ACCRETE</title>

    <style>
      html,
      body,
      canvas {
        position: absolute;
        top: 0;
        left: 0;
        padding: 0;
        margin: 0;
        height: 100vh;
        width: 100vw;
        z-index: 0;
      }
      button {
        position: relative;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <button>Generate Star System</button> <canvas></canvas>
    <script>
      var accrete = new Worker("dist/accrete.worker.js");
      var canvas = document.querySelector("canvas");
      canvas.height = document.body.offsetHeight;
      canvas.width = document.body.offsetWidth;

      const hscale =
        (canvas.width % 3 === 0 ? canvas.width - 1 : canvas.width) / 3;
      const vscale =
        (canvas.height % 2 === 0 ? canvas.height - 1 : canvas.height) / 2;
      const rscale = hscale / (0.5 * vscale);

      var ctx = canvas.getContext("2d");
      ctx.font = "12px monospace";
      var btn = document.querySelector("button");
      var loadingInterval;

      btn.onclick = function(e) {
        accrete.postMessage("GENERATE_PLANETS");
        e.target.disabled = true;
        var i = 0;

        loadingInterval = setInterval(function() {
          var l = ((e.target.innerText.match(/\.+$/) || [])[1] || "").length;
          i += 1;
          e.target.innerText =
            "Generating" + new Array(i % 4).fill(".").join("");
        }, 500);
      };

      function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const width = hscale * 3;
        const height = vscale * 2;

        const ticklen = vscale / 10;
        const ytick = height - ticklen;

        ctx.fillText(
          "1 AU",
          hscale - ctx.measureText("1 AU").width / 2,
          height - 2 * ticklen - 12
        );

        ctx.fillText(
          "10 AU",
          2 * hscale - ctx.measureText("1 AU").width / 2,
          height - 2 * ticklen - 12
        );

        ctx.moveTo(hscale, height);
        ctx.lineTo(hscale, height - 2 * ticklen);

        ctx.moveTo(2 * hscale, height);
        ctx.lineTo(2 * hscale, height - 2 * ticklen);

        ctx.stroke();

        for (var i = 2; i < 10; i++) {
          const offset = hscale * Math.log10(i);
          ctx.moveTo(offset, height);
          ctx.lineTo(offset, ytick);

          ctx.moveTo(offset + hscale, height);
          ctx.lineTo(offset + hscale, ytick);

          ctx.moveTo(offset + 2 * hscale, height);
          ctx.lineTo(offset + 2 * hscale, ytick);
        }

        ctx.stroke();
      }

      function drawPlanet(p) {
        ctx.beginPath();

        const au = Math.log10(p.axis);
        const rad = Math.pow(p.earthMass, 1 / 3);
        const r = Math.max(1, rad * rscale);
        const x0 = au * hscale;
        const x = x0 + hscale - r;
        const y = vscale - r;

        if (p.isGasGiant) {
          ctx.arc(x, y, 2 * r, 0, 2 * Math.PI);
          ctx.stroke();
        } else {
          ctx.arc(x, y, 2 * r, 0, 2 * Math.PI);
          ctx.fill();
        }
      }

      drawGrid();

      accrete.onmessage = function(e) {
        btn.disabled = false;
        btn.innerText = "Generate Star System";
        clearInterval(loadingInterval);

        const planets = e.data;
        var s = 50 / canvas.width;
        var inc = 100;

        drawGrid();
        console.log(planets.sort((p1, p2) => p1.axis - p2.axis));
        planets
          .sort((p1, p2) => p1.axis - p2.axis)
          .map((p, i) => {
            var a = p.axis.toFixed(2) + " AU";
            var m = p.earthMass.toFixed(2) + " MâŠ•";

            var shade = Math.floor(
              ((0.6 * planets.length - i) / planets.length) * 255
            );
            var rgba = [shade, shade, shade, 1];
            ctx.fillStyle = `rgba(${rgba.join(",")})`;

            drawPlanet(p);
          });
      };
    </script>
  </body>
</html>
